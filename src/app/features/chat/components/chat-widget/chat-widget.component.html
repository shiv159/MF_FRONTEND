@if (chatService.isVisible()) {
<div class="fixed inset-x-3 bottom-3 sm:inset-auto sm:bottom-4 sm:right-4 z-50 flex flex-col items-end">

  <!-- Chat Window -->
  @if (isOpen()) {
  <div
    class="w-full sm:w-96 h-[calc(100dvh-7.5rem)] max-h-[36rem] sm:h-[500px] sm:max-h-[500px] bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 shadow-xl rounded-2xl sm:rounded-lg flex flex-col mb-3 sm:mb-4 overflow-hidden transition-all">

    <!-- Header -->
    <div class="bg-blue-600 text-white p-3 sm:p-4 flex justify-between items-center gap-3">
      <h3 class="font-semibold">AI Portfolio Assistant</h3>
      <div class="flex gap-2">
        <button (click)="resetChat()" class="text-xs hover:bg-blue-700 px-2 py-1 rounded"
          title="Start New Chat">New</button>
        <button (click)="toggleChat()" class="hover:bg-blue-700 p-1 rounded">
          <span class="text-xl">&times;</span>
        </button>
      </div>
    </div>

    <!-- Messages Area -->
    <div #messagesContainer class="flex-1 overflow-y-auto p-3 sm:p-4 bg-gray-50 dark:bg-gray-900 flex flex-col gap-3">
      
      <!-- Pre-defined Prompts (shown when empty) -->
      @if (showPrompts()) {
      <div class="flex flex-col gap-3">
        <p class="text-sm text-gray-500 dark:text-gray-400 text-center mb-2">
          Ask me anything about your portfolio:
        </p>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
          @for (p of predefinedPrompts; track p.prompt) {
          <button 
            (click)="sendPredefinedPrompt(p.prompt)"
            class="flex items-center gap-2 px-3 py-2 bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg text-sm text-gray-700 dark:text-gray-200 hover:bg-blue-50 dark:hover:bg-gray-600 hover:border-blue-300 dark:hover:border-blue-500 transition-colors text-left">
            <span class="text-lg">{{ p.icon }}</span>
            <span>{{ p.label }}</span>
          </button>
          }
        </div>
      </div>
      }

      @for (msg of chatService.messages(); track msg.id) {
        <div
        [class]="msg.role === 'user' ? 'self-end bg-blue-100 dark:bg-blue-900 text-gray-900 dark:text-gray-100' : 'self-start bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 text-gray-900 dark:text-gray-100'"
        class="max-w-[92%] sm:max-w-[85%] rounded-lg p-3 text-sm shadow-sm">

        <!-- Content with Markdown rendering for assistant messages -->
        @if (msg.role === 'assistant') {
        <div class="prose prose-sm dark:prose-invert max-w-none leading-relaxed chat-markdown">
          <markdown [data]="msg.content"></markdown>
        </div>
        } @else {
        <div class="whitespace-pre-wrap leading-relaxed">{{ msg.content }}</div>
        }

        <!-- Metadata -->
        <div class="text-[10px] text-gray-400 dark:text-gray-500 mt-1 text-right">
          {{ msg.timestamp | date:'shortTime' }}
        </div>
      </div>
      }

      <!-- Loading Indicator -->
      @if (chatService.isLoading() && !isStreaming()) {
      <div
        class="self-start bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded-lg p-3 text-sm">
        <div class="flex items-center gap-2">
          <div class="flex gap-1">
            <div class="w-2 h-2 bg-blue-500 rounded-full animate-bounce" style="animation-delay: 0ms;"></div>
            <div class="w-2 h-2 bg-blue-500 rounded-full animate-bounce" style="animation-delay: 150ms;"></div>
            <div class="w-2 h-2 bg-blue-500 rounded-full animate-bounce" style="animation-delay: 300ms;"></div>
          </div>
          <span class="text-gray-500 dark:text-gray-400">Thinking...</span>
        </div>
      </div>
      }
    </div>

    <!-- Input Area -->
    <div class="p-3 bg-white dark:bg-gray-800 border-t border-gray-100 dark:border-gray-700">
      <div class="flex gap-2">
        <input #msgInput (keyup.enter)="sendMessage(msgInput.value); msgInput.value = ''" type="text"
          placeholder="Ask about your portfolio..."
          class="flex-1 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 rounded-md px-3 py-2 text-sm focus:outline-none focus:border-blue-500 transition-colors placeholder-gray-400 dark:placeholder-gray-500" />
        <button (click)="sendMessage(msgInput.value); msgInput.value = ''" [disabled]="chatService.isLoading()"
          class="shrink-0 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors font-medium text-sm">
          Send
        </button>
      </div>
    </div>

  </div>
  }

  <!-- Toggle Button -->
  <button (click)="toggleChat()"
    class="bg-blue-600 hover:bg-blue-700 text-white w-12 h-12 sm:w-14 sm:h-14 rounded-full shadow-lg flex items-center justify-center transition-transform hover:scale-105">
    <!-- Chat Icon (SVG) -->
    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
        d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
    </svg>
  </button>

</div>
}
