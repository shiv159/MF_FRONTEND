<div class="page-container">
    <!-- Header -->
    <header class="page-header">
        <div class="header-left">
            <button (click)="goBack()" class="back-btn" aria-label="Go back">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                </svg>
            </button>
            <div class="brand">
                <div class="brand-icon">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 17l5-5 4 4 7-8">
                        </path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 8h6v6"></path>
                    </svg>
                </div>
                <span class="brand-text">Plan<span class="text-primary-500">MyFunds</span></span>
            </div>
        </div>
        <ui-theme-toggle></ui-theme-toggle>
    </header>

    <!-- Main Content -->
    <main class="page-main">
        <div class="content-container">

            <!-- Page Header -->
            @if (!resultData()) {
            <div class="page-header-content">
                <h1 class="page-title">Analyze Your Current Funds</h1>
                <p class="page-subtitle">Add your holdings to analyze overlap and risk, then improve your portfolio mix.
                </p>
            </div>
            }

            <!-- Form View -->
            @if (!resultData() && !isLoading()) {
            <div class="form-section">
                <!-- Weight Indicator -->
                <app-weight-total [total]="totalWeight()"></app-weight-total>

                <!-- Fund Rows -->
                <div class="rows-container">
                    @for (item of selections(); track $index) {
                    <app-selection-row [index]="$index" [item]="item" (update)="onRowUpdate($event)"
                        (remove)="removeRow($event)">
                    </app-selection-row>
                    }

                    <!-- Add Button -->
                    <button (click)="addRow()" class="add-btn">
                        <svg class="w-5 h-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd"
                                d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z"
                                clip-rule="evenodd" />
                        </svg>
                        Add Another Fund
                    </button>
                </div>

                <!-- Submit -->
                <div class="actions">
                    <button [disabled]="totalWeight() !== 100" (click)="submit()" class="submit-btn">
                        Analyze Portfolio
                    </button>
                </div>
            </div>
            }

            <!-- Loading View -->
            @if (isLoading()) {
            <div class="loading-card">
                <h3 class="loading-title">Analyzing your portfolio...</h3>
                <app-loading-skeleton [rows]="6"></app-loading-skeleton>
            </div>
            }

            <!-- Enrichment Failure Warning -->
            @if (failedFunds().length > 0) {
            <div class="enrichment-warning-banner">
                <div class="warning-icon">⚠️</div>
                <div class="warning-content">
                    <p class="warning-title">
                        {{ failedFunds().length }} fund{{ failedFunds().length > 1 ? 's' : '' }} could not be resolved
                        and {{ failedFunds().length > 1 ? 'were' : 'was' }} excluded from your portfolio.
                        Remaining weights have been re-normalised to 100%.
                    </p>
                    <ul class="warning-list">
                        @for (f of failedFunds(); track f.inputFundName) {
                        <li>
                            <strong>{{ f.inputFundName ?? f.inputFundId ?? 'Unknown fund' }}</strong>
                            — {{ f.message }}
                        </li>
                        }
                    </ul>
                </div>
            </div>
            }

            <!-- Results View -->
            @if (resultData(); as data) {
            <app-selection-result [data]="data" [diagnosticData]="diagnosticData()"
                [isAnalyzing]="isAnalyzing()"></app-selection-result>
            }

        </div>
    </main>
</div>